#!/bin/sh
set -eu

SCRIPT_NAME=vpn-runner

# Define logging wrapper functions.
log() { logger -t "$SCRIPT_NAME" -p daemon.notice "$*"; }
log_err() { logger -t "$SCRIPT_NAME" -p daemon.err "$*"; }

# Delay startup to ensure network is settled.
sleep 10

# Ensure the script is run as root.
if [ "$(id -u)" -ne 0 ]; then
    log_err "Error: This script must be run as root. Exiting."
    exit 1
fi

# Load environment variables from /usr/local/etc/.gateway-env.conf config file.
. /usr/local/etc/.gateway-env.conf

# Configuration: timeouts, intervals, and retry settings.
OVPN_PROXY_PORT=$(tail -n 1 "${OVPN_PROXY_AUTH:-}" 2>/dev/null || echo 0)
GATEWAY_TIMEOUT=10 # Total seconds to wait for default gateway(s).
INTERVAL=1         # Polling interval in seconds.

# Get current default gateway interface.
EXT_IF_CUR=$(netstat -rn -f inet 2>/dev/null | awk '$1 == "default" {print $4; exit}')

# Build a newline-separated list of candidates, filtering out the current default.
CANDIDATE_LINES=$(echo "$EXT_IF_LIST" | tr ',' '\n' | grep -Fvx "$EXT_IF_CUR")

if [ -z "$CANDIDATE_LINES" ]; then
    log_err "Error: No candidate interfaces available."
    exit 1
fi

# Loop until we have a working gateway or run out of candidates.
EXT_IF_NEW=""
EXT_IF_AVAILABLE=0
DEFAULT_GW_IPV4=""
while [ -n "$CANDIDATE_LINES" ]; do
    # Pick a random index (1â€¦NUM_CANDIDATES).
    RAND=$(od -An -N2 -tu2 /dev/urandom | tr -d ' ')
    INDEX=$((RAND % $(echo "$CANDIDATE_LINES" | wc -l) + 1))

    # Grab exactly that line.
    EXT_IF_NEW=$(echo "$CANDIDATE_LINES" | sed -n "${INDEX}p")

    remove_current() {
        CANDIDATE_LINES=$(echo "$CANDIDATE_LINES" | sed "${INDEX}d")
    }

    # Verify the specified interface exists.
    EXT_IF_AVAILABLE=$([ -n "$EXT_IF_NEW" ] && ifconfig "$EXT_IF_NEW" >/dev/null 2>&1 && echo 1 || echo 0)
    if [ "$EXT_IF_AVAILABLE" -ne 1 ]; then
        remove_current
        continue
    fi

    # Delete existing default routes for IPv4 and IPv6.
    route -n delete -inet default || true
    route -n delete -inet6 default || true

    # Restart the DHCP client service on the interface.
    if ! service dhclient restart "$EXT_IF_NEW"; then
        log_err "DHCP restart failed on $EXT_IF_NEW; trying another interface."
        remove_current
        continue
    fi

    # Poll for default gateway on this interface.
    SECONDS_WAITED=0

    while [ "$SECONDS_WAITED" -lt "$GATEWAY_TIMEOUT" ]; do
        DEFAULT_GW_IPV4=$(netstat -rn -f inet 2>/dev/null | awk -v iface="$EXT_IF_NEW" '$1 == "default" && $4 == iface {print $2; exit}')
        if [ -z "$DEFAULT_GW_IPV4" ]; then
            sleep "$INTERVAL"
            SECONDS_WAITED=$((SECONDS_WAITED + INTERVAL))
            continue
        fi
        break
    done

    if [ -z "$DEFAULT_GW_IPV4" ]; then
        log_err "Failed to obtain DHCP default gateway on $EXT_IF_NEW; trying another interface."
        remove_current
        continue
    fi

    # Break out of the loop now that the interface is up.
    break
done

if [ -z "$DEFAULT_GW_IPV4" ]; then
    log_err "Error: Failed to discover a default gateway after trying all interfaces."
    exit 1
fi

if ! timeout 5 nc -z -4 "$DEFAULT_GW_IPV4" 5201 >/dev/null 2>&1; then
    # Connect directly to the server.
    OVPN_PROXY_PORT=0
fi

# Update the OpenVPN configuration.
if [ "$EXT_IF_AVAILABLE" -eq 1 ] && [ -f "${OVPN_PROXY_AUTH:-}" ] &&
    [ -n "$DEFAULT_GW_IPV4" ] && [ "$OVPN_PROXY_PORT" -gt 0 ]; then
    sed -e "s|__AUTH_FILE__|$OVPN_AUTH|" \
        -e "s|__PROXY_STRING__|${DEFAULT_GW_IPV4} ${OVPN_PROXY_PORT}|" \
        -e "s|__PROXY_AUTH_FILE__|$OVPN_PROXY_AUTH|" \
        "$OVPN_TEMPLATE" >"$OVPN_FILE"
else
    sed -e "s|__AUTH_FILE__|$OVPN_AUTH|" \
        -e "/__PROXY_STRING__/d" \
        -e "/__PROXY_AUTH_FILE__/d" \
        "$OVPN_TEMPLATE" >"$OVPN_FILE"
fi

# Start the OpenVPN service with elevated priority to reduce latency.
if command -v rtprio >/dev/null 2>&1; then
    # Realtime class priority 10 (0 highest).
    exec rtprio 10 openvpn --syslog openvpn --config "$OVPN_FILE" --writepid /var/run/openvpn.pid
else
    # Fallback to highest nice if rtprio is unavailable.
    exec nice -n -20 openvpn --syslog openvpn --config "$OVPN_FILE" --writepid /var/run/openvpn.pid
fi
