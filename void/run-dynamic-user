#!/bin/sh
# run-dynamic-user: wrapper to launch a runit service with a secure, unprivileged dynamic user
# Usage (in service run script): /path/to/run-dynamic-user --service NAME [--create-home] -- <command> [args...]
# Example runit run script:
#   #!/bin/sh
#   exec /path/to/run-dynamic-user --service myservice --create-home -- your-daemon --flags

set -eu
umask 077

if [ "$(id -u)" -ne 0 ]; then
    echo "Error: This script must be run as root." >&2
    exit 1
fi

usage() {
    echo "Usage: $0 --service NAME [--create-home] -- <command> [args...]" >&2
    exit 1
}

enable_home=false
SERVICE=""
while [ "$#" -gt 0 ]; do
    case "$1" in
    --service)
        SERVICE="${2-}"
        case "$SERVICE" in
        [A-Za-z0-9_-]*) ;;
        *) usage ;;
        esac
        shift 2
        ;;
    --create-home)
        enable_home=true
        shift
        ;;
    --)
        shift
        break
        ;;
    *)
        usage
        ;;
    esac
done

[ "$#" -ge 1 ] || usage

if [ -z "$SERVICE" ]; then
    echo "Service name is required (use --service)." >&2
    usage
fi

SCRIPT_DIR=$(cd -- "$(dirname -- "$0")" && pwd -P)
FINISH_HELPER="$SCRIPT_DIR/finish-dynamic-user"

SRV_RUN="/run/${SERVICE}"
PERSIST_BASE="/var/lib/runit-dynuser"
PERSIST_DIR="${PERSIST_BASE}/${SERVICE}"
PERSIST_ID="${PERSIST_DIR}/identity"

if [ -L "$SRV_RUN" ]; then
    echo "Refusing to use symlinked runtime directory $SRV_RUN" >&2
    exit 1
fi

if [ -e "$SRV_RUN" ]; then
    STALE="true"
fi

if [ -L "$PERSIST_DIR" ]; then
    echo "Refusing to use symlinked persistent directory $PERSIST_DIR" >&2
    exit 1
fi

if [ -e "$PERSIST_ID" ]; then
    STALE="true"
fi

if [ "${STALE-}" = "true" ]; then
    if [ ! -x "$FINISH_HELPER" ]; then
        echo "Stale dynamic user state detected but $FINISH_HELPER is not executable." >&2
        exit 1
    fi
    echo "Stale dynamic user state detected; invoking finish-dynamic-user for $SERVICE" >&2
    if ! "$FINISH_HELPER" --service "$SERVICE"; then
        echo "Failed to clean previous dynamic user state for $SERVICE." >&2
        exit 1
    fi
fi

if [ -e "$SRV_RUN" ] || [ -e "$PERSIST_ID" ]; then
    echo "Refusing to start: dynamic user state still present for $SERVICE." >&2
    exit 1
fi

UID=""
GID=""
CLEAN_USER=""
CLEAN_GROUP=""
CLEAN_PERSIST=false
cleanup() {
    # Cleanup only runs if setup fails before exec
    if [ -n "$CLEAN_USER" ] && [ -n "$UID" ]; then
        pkill -u "$UID" >/dev/null 2>&1 || true
    fi
    if [ -n "$CLEAN_USER" ]; then
        userdel "$CLEAN_USER" >/dev/null 2>&1 || true
    fi
    if [ -n "$CLEAN_GROUP" ]; then
        groupdel "$CLEAN_GROUP" >/dev/null 2>&1 || true
    fi
    if [ -d "$SRV_RUN" ]; then
        rm -rf "$SRV_RUN"
    fi
    if [ "$CLEAN_PERSIST" = true ] && [ -d "$PERSIST_DIR" ]; then
        rm -rf "$PERSIST_DIR"
    fi
}
trap cleanup EXIT INT TERM

install -d -m 700 -o root -g root "$SRV_RUN"
install -d -m 700 -o root -g root "$PERSIST_DIR"
CLEAN_PERSIST=true

DYN_HOME="/nonexistent"
[ "$enable_home" = true ] && DYN_HOME="$SRV_RUN/home"

# Generate a unique dynamic user/group name
USER=""
GROUP=""
for _ in 1 2 3 4 5; do
    dynrand=$(LC_ALL=C tr -dc 'a-z0-9' </dev/urandom | head -c 10)
    candidate="svc_${SERVICE}_${dynrand}"
    if ! getent passwd "$candidate" >/dev/null 2>&1 && ! getent group "$candidate" >/dev/null 2>&1; then
        USER="$candidate"
        GROUP="$candidate"
        break
    fi
done

if [ -z "$USER" ] || [ -z "$GROUP" ]; then
    echo "Unable to generate unique dynamic user name." >&2
    exit 1
fi

for id in $(seq 60000 64999); do
    if ! getent passwd "$id" >/dev/null 2>&1 && ! getent group "$id" >/dev/null 2>&1; then
        UID="$id"
        GID="$id"
        break
    fi
done

if [ -z "$UID" ] || [ -z "$GID" ]; then
    echo "No free UID/GID available." >&2
    exit 1
fi

groupadd -g "$GID" "$GROUP"
CLEAN_GROUP="$GROUP"
useradd -u "$UID" -g "$GROUP" -d "$DYN_HOME" -M -N -r -s /usr/sbin/nologin "$USER"
CLEAN_USER="$USER"

if [ "$enable_home" = true ]; then
    install -d -m 700 -o "$USER" -g "$GROUP" "$DYN_HOME"
fi

printf '%s:%s:%s:%s\n' "$USER" "$UID" "$GROUP" "$GID" >"$PERSIST_ID"
chmod 600 "$PERSIST_ID"

WORKDIR="$SRV_RUN/work"
install -d -m 700 -o "$USER" -g "$GROUP" "$WORKDIR"

# Finally, execute the daemon under the dynamic user
exec chpst -u "$USER:$GROUP" -- "$@"
