#!/bin/sh
# finish-dynamic-user: cleanup dynamic user and service runtime directory
# Usage (in service finish script): exec /path/to/finish-dynamic-user --service NAME
# Example runit finish script:
#   #!/bin/sh
#   exec /path/to/finish-dynamic-user --service myservice

set -eu
umask 077

if [ "$(id -u)" -ne 0 ]; then
    echo "Error: This script must be run as root." >&2
    exit 1
fi

usage() {
    echo "Usage: $0 --service NAME" >&2
    exit 1
}

SERVICE=""
while [ "$#" -gt 0 ]; do
    case "$1" in
    --service)
        SERVICE="${2-}"
        case "$SERVICE" in
        [A-Za-z0-9_-]*) ;;
        *) usage ;;
        esac
        shift 2
        ;;
    --help | -h)
        usage
        ;;
    *)
        usage
        ;;
    esac
done

if [ -z "$SERVICE" ]; then
    echo "Service name is required (use --service)." >&2
    usage
fi

OS="$(uname -s)"
case "$OS" in
Linux) RUNTIME_BASE="/run" ;;
FreeBSD) RUNTIME_BASE="/var/run" ;;
*)
    echo "Unsupported OS: $OS" >&2
    exit 1
    ;;
esac
[ -d "$RUNTIME_BASE" ] || RUNTIME_BASE="/run"

if [ -d "/var/lib" ]; then
    PERSIST_BASE="/var/lib/runit-dynuser"
else
    PERSIST_BASE="/var/db/runit-dynuser"
fi

del_user() {
    name="$1"
    case "$OS" in
    Linux) userdel -f "$name" ;;
    FreeBSD) pw userdel -n "$name" -r ;;
    esac
}

del_group() {
    name="$1"
    case "$OS" in
    Linux) groupdel "$name" ;;
    FreeBSD) pw groupdel -n "$name" ;;
    esac
}

SRV_RUN="${RUNTIME_BASE}/${SERVICE}"
PERSIST_DIR="${PERSIST_BASE}/${SERVICE}"
PERSIST_ID="${PERSIST_DIR}/identity"

[ -L "$SRV_RUN" ] && {
    echo "Refusing to touch symlinked runtime directory $SRV_RUN" >&2
    exit 1
}

[ -L "$PERSIST_DIR" ] && {
    echo "Refusing to touch symlinked persistent directory $PERSIST_DIR" >&2
    exit 1
}

if [ ! -f "$PERSIST_ID" ] && [ ! -d "$SRV_RUN" ]; then
    exit 0
fi

if [ ! -f "$PERSIST_ID" ]; then
    rm -rf "$SRV_RUN" "$PERSIST_DIR"
    exit 0
fi

IFS=':' read -r USER UID GROUP GID <"$PERSIST_ID"

case "$USER" in
svc_${SERVICE}_*) ;;
*)
    echo "Refusing to delete unexpected user $USER for service $SERVICE" >&2
    exit 1
    ;;
esac

case "$GROUP" in
"$USER") ;;
*)
    echo "Refusing to delete unexpected group $GROUP for service $SERVICE" >&2
    exit 1
    ;;
esac

case "$UID" in
'' | *[!0-9]*)
    echo "Invalid UID recorded for $SERVICE" >&2
    exit 1
    ;;
esac

case "$GID" in
'' | *[!0-9]*)
    echo "Invalid GID recorded for $SERVICE" >&2
    exit 1
    ;;
esac

if pgrep -u "$UID" >/dev/null 2>&1; then
    pkill -TERM -u "$UID" >/dev/null 2>&1 || true
    sleep 1
    pkill -KILL -u "$UID" >/dev/null 2>&1 || true
fi

del_user "$USER" >/dev/null 2>&1 || true
del_group "$GROUP" >/dev/null 2>&1 || true

rm -rf "$SRV_RUN" "$PERSIST_DIR"
