#!/data/data/com.termux/files/usr/bin/sh
set -eu

TARGET="$(head -n 1 ./env/TARGET | tr -d '[:space:]')"
ADDR="${BIND_IP:-0.0.0.0}"
PORT="${BIND_PORT:-21080}"

# Optional: configure bind IP and validate it's not empty or blank
if [ -f ./env/BIND_IP ]; then
    ADDR_OVERRIDE="$(head -n 1 ./env/BIND_IP | tr -d '[:space:]')"
    if [ -n "$ADDR_OVERRIDE" ]; then
        ADDR="$ADDR_OVERRIDE"
    fi
fi

# Allow override of bind port via env/BIND_PORT if set
if [ -f ./env/BIND_PORT ]; then
    PORT_OVERRIDE="$(head -n 1 ./env/BIND_PORT | tr -d '[:space:]')"
    if [ -n "$PORT_OVERRIDE" ]; then
        PORT="$PORT_OVERRIDE"
    fi
fi

exec nice -n -20 ~/.bin/udp-forwarder "$ADDR":"$PORT" "$TARGET" --on-timeout exit
